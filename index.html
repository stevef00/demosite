<!--
  DVD Collection Tracker (External Data Version)
  --------------------------------------------------
  ✦ HOW TO USE ✦
  1. Create a file named `dvd_data.json` in the same folder as this HTML file.
     Structure:
       {
         "owned": ["Blade Runner (1982)", "The Matrix (1999)"],
         "wishlist": ["Seven Samurai (1954)", "Alien (1979)"]
       }
  2. Open this HTML file in a browser (served from a local web server or
     with the `file:` protocol in modern browsers that allow `fetch`).
  3. Edit `dvd_data.json` whenever you want to change the lists.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="styles.css">
  <title>DVD Collection Tracker</title>
</head>
<body>
  <h1>DVD Collection Tracker</h1>
  <p class="search-info">Click a title to move it between lists. Alt-click to delete it.</p>

  <div class="search-container">
    <input id="searchBox" type="search" placeholder="Search DVDs…" autocomplete="off" />
    <div class="search-info" id="searchInfo">Type to search both lists</div>
    <button class="clear-search-button">Clear Search</button>
  </div>

  <div class="list-section" id="wishWrapper">
    <h2>Wishlist <span class="list-count" id="wishCount">0</span></h2>
    <ul id="wishList"></ul>
    <div class="add-form">
      <input id="wishInput" type="text" placeholder="Add to wishlist" />
      <button id="wishAdd">Add</button>
    </div>
  </div>

  <div class="list-section" id="ownedWrapper">
    <h2>Owned <span class="list-count" id="ownedCount">0</span></h2>
    <ul id="ownedList"></ul>
    <div class="add-form">
      <input id="ownedInput" type="text" placeholder="Add to owned" />
      <button id="ownedAdd">Add</button>
    </div>
  </div>

  <footer id="lastModified">
    <p>Last modified: <span id="lastModifiedDate">Loading...</span></p>
  </footer>

  <script>
    let data = { owned: [], wishlist: [] };

    function loadFromLocalStorage() {
      const cached = localStorage.getItem('dvdData');
      if (cached) {
        try {
          data = JSON.parse(cached);
          return true;
        } catch (err) {
          console.error('Failed to parse cached data', err);
          localStorage.removeItem('dvdData');
          localStorage.removeItem('dvdDataTimestamp');
        }
      }
      return false;
    }

    function saveToLocalStorage() {
      localStorage.setItem('dvdData', JSON.stringify(data));
      localStorage.setItem('dvdDataTimestamp', Date.now().toString());
    }

    async function loadData() {
      if (loadFromLocalStorage()) {
        const ts = localStorage.getItem('dvdDataTimestamp');
        const lastModifiedDateEl = document.getElementById('lastModifiedDate');
        if (ts) {
          const date = new Date(parseInt(ts, 10));
          lastModifiedDateEl.textContent = date.toLocaleString();
        } else {
          lastModifiedDateEl.textContent = 'Local data';
        }
        return;
      }

      try {
        const res = await fetch('dvd_data.json');
        if (!res.ok) throw new Error(res.status);

        const lastModified = res.headers.get('last-modified');
        const lastModifiedDateEl = document.getElementById('lastModifiedDate');
        if (lastModified) {
          const date = new Date(lastModified);
          lastModifiedDateEl.textContent = date.toLocaleString();
        } else {
          lastModifiedDateEl.textContent = 'Date not available';
        }

        data = await res.json();
        saveToLocalStorage();
      } catch (err) {
        console.error('Could not load dvd_data.json', err);
        const lastModifiedDateEl = document.getElementById('lastModifiedDate');
        lastModifiedDateEl.textContent = 'Error loading data';
      }
    }

    const ownedListEl = document.getElementById('ownedList');
    const wishListEl = document.getElementById('wishList');
    const searchBox = document.getElementById('searchBox');
    const searchInfo = document.getElementById('searchInfo');
    const clearButton = document.querySelector('.clear-search-button');
    const wishInput = document.getElementById('wishInput');
    const ownedInput = document.getElementById('ownedInput');
    const wishAdd = document.getElementById('wishAdd');
    const ownedAdd = document.getElementById('ownedAdd');

    function updateClearButton() {
      if (searchBox.value.trim()) {
        clearButton.classList.add('visible');
      } else {
        clearButton.classList.remove('visible');
      }
    }

    function clearSearch() {
      searchBox.value = '';
      searchBox.focus();
      render();
      updateClearButton();
    }

    function highlightMatch(text, filter) {
      if (!filter) return text;
      const regex = new RegExp(`(${filter.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(regex, '<span class="match-highlight">$1</span>');
    }

    function addItem(list, inputEl) {
      const title = inputEl.value.trim();
      if (!title) return;
      data[list].push(title);
      inputEl.value = '';
      saveToLocalStorage();
      render(searchBox.value.trim());
    }

    function render(filter = '') {
      const normFilter = filter.toLowerCase();
      const wishMatches = data.wishlist
        .map((t, i) => ({ t, i }))
        .filter(o => !normFilter || o.t.toLowerCase().includes(normFilter));
      const ownedMatches = data.owned
        .map((t, i) => ({ t, i }))
        .filter(o => !normFilter || o.t.toLowerCase().includes(normFilter));

      // Update counts
      document.getElementById('wishCount').textContent = data.wishlist.length;
      document.getElementById('ownedCount').textContent = data.owned.length;

      // Render wishlist
      if (wishMatches.length === 0 && normFilter) {
        wishListEl.innerHTML = '<li class="no-results">No wishlist items match your search</li>';
      } else {
        wishListEl.innerHTML = wishMatches.map(o =>
          `<li class="wishlist-item" data-index="${o.i}">
            ${highlightMatch(o.t, normFilter)}
            <div class="status-indicator status-wishlist"></div>
          </li>`
        ).join('');
      }

      // Render owned list
      if (ownedMatches.length === 0 && normFilter) {
        ownedListEl.innerHTML = '<li class="no-results">No owned items match your search</li>';
      } else {
        ownedListEl.innerHTML = ownedMatches.map(o =>
          `<li class="owned-item" data-index="${o.i}">
            ${highlightMatch(o.t, normFilter)}
            <div class="status-indicator status-owned"></div>
          </li>`
        ).join('');
      }

      // Update search info
      if (normFilter) {
        const totalMatches = wishMatches.length + ownedMatches.length;
        searchInfo.textContent = `Found ${totalMatches} match${totalMatches !== 1 ? 'es' : ''}`;
      } else {
        searchInfo.textContent = 'Type to search both lists';
      }
    }

    async function init() {
      await loadData();
      render();

      searchBox.addEventListener('input', e => {
        render(e.target.value.trim());
        updateClearButton();
      });

      clearButton.addEventListener('click', clearSearch);

      wishAdd.addEventListener('click', () => addItem('wishlist', wishInput));
      ownedAdd.addEventListener('click', () => addItem('owned', ownedInput));

      wishInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          wishAdd.click();
        }
      });
      ownedInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          ownedAdd.click();
        }
      });

      wishListEl.addEventListener('click', e => {
        const li = e.target.closest('li[data-index]');
        if (!li) return;
        const idx = parseInt(li.dataset.index, 10);
        if (e.altKey) {
          data.wishlist.splice(idx, 1);
        } else {
          const [item] = data.wishlist.splice(idx, 1);
          data.owned.push(item);
        }
        saveToLocalStorage();
        render(searchBox.value.trim());
      });

      ownedListEl.addEventListener('click', e => {
        const li = e.target.closest('li[data-index]');
        if (!li) return;
        const idx = parseInt(li.dataset.index, 10);
        if (e.altKey) {
          data.owned.splice(idx, 1);
        } else {
          const [item] = data.owned.splice(idx, 1);
          data.wishlist.push(item);
        }
        saveToLocalStorage();
        render(searchBox.value.trim());
      });

    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
